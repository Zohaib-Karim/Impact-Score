import { type NextRequest, NextResponse } from "next/server"
import { database } from "@/lib/db"
import { GoogleGenerativeAI } from "@google/generative-ai"

const genAI = new GoogleGenerativeAI(process.env.GOOGLE_GENERATIVE_AI_API_KEY || "")

function getFallbackResponse(message: string, language: string): string {
  const lowerMessage = message.toLowerCase()

  const responses: Record<string, Record<string, string>> = {
    photosynthesis: {
      en: "Photosynthesis is how plants make their own food using sunlight, water, and carbon dioxide! ЁЯМ▒ The green parts of plants capture sunlight and turn it into energy. It's like plants having their own solar panels!",
      hi: "рдкреНрд░рдХрд╛рд╢ рд╕рдВрд╢реНрд▓реЗрд╖рдг рд╡рд╣ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╣реИ рдЬрд┐рд╕рд╕реЗ рдкреМрдзреЗ рд╕реВрд░реНрдп рдХреЗ рдкреНрд░рдХрд╛рд╢, рдкрд╛рдиреА рдФрд░ рдХрд╛рд░реНрдмрди рдбрд╛рдЗрдСрдХреНрд╕рд╛рдЗрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЕрдкрдирд╛ рднреЛрдЬрди рдмрдирд╛рддреЗ рд╣реИрдВ! ЁЯМ▒ рдкреМрдзреЛрдВ рдХреЗ рд╣рд░реЗ рднрд╛рдЧ рд╕реВрд░реНрдп рдХреЗ рдкреНрд░рдХрд╛рд╢ рдХреЛ рдкрдХрдбрд╝рддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕реЗ рдКрд░реНрдЬрд╛ рдореЗрдВ рдмрджрд▓ рджреЗрддреЗ рд╣реИрдВред рдпрд╣ рдРрд╕рд╛ рд╣реИ рдЬреИрд╕реЗ рдкреМрдзреЛрдВ рдХреЗ рдкрд╛рд╕ рдЕрдкрдиреЗ рд╕реМрд░ рдкреИрдирд▓ рд╣реЛрдВ!",
      ta: "роТро│ро┐роЪрпНроЪрпЗро░рпНроХрпНроХрпИ роОройрпНрокродрпБ родро╛ро╡ро░роЩрпНроХро│рпН роЪрпВро░ро┐роп роТро│ро┐, роирпАро░рпН рооро▒рпНро▒рпБроорпН роХро╛ро░рпНрокройрпН роЯрпИ роЖроХрпНроЪрпИроЯрпИрокрпН рокропройрпНрокроЯрпБродрпНродро┐ родроЩрпНроХро│рпН роЪрпКроирпНрод роЙрогро╡рпИ роЙро░рпБро╡ро╛роХрпНроХрпБроорпН роорпБро▒рпИропро╛роХрпБроорпН! ЁЯМ▒ родро╛ро╡ро░роЩрпНроХро│ро┐ройрпН рокроЪрпНроЪрпИ рокроХрпБродро┐роХро│рпН роЪрпВро░ро┐роп роТро│ро┐ропрпИрокрпН рокро┐роЯро┐родрпНродрпБ роЕродрпИ роЖро▒рпНро▒ро▓ро╛роХ рооро╛ро▒рпНро▒рпБроХро┐ройрпНро▒рой. роЗродрпБ родро╛ро╡ро░роЩрпНроХро│рпБроХрпНроХрпБ роЪрпКроирпНрод роЪрпВро░ро┐роп рокрпЗройро▓рпНроХро│рпН роЗро░рпБрокрпНрокродрпБ рокрпЛройрпНро▒родрпБ!",
      te: "р░Хр░┐р░░р░гр░Ьр░ир▒Нр░п р░╕р░Вр░пр▒Лр░Чр░Хр▒Нр░░р░┐р░п р░Ер░Вр░Яр▒З р░ор▒Кр░Хр▒Нр░Хр░▓р▒Б р░╕р▒Вр░░р▒Нр░пр░░р░╢р▒Нр░ор░┐, р░ир▒Ар░░р▒Б р░ор░░р░┐р░пр▒Б р░Хр░╛р░░р▒Нр░мр░ир▒Н р░бр░пр░╛р░Хр▒Нр░╕р▒Ир░бр▒НтАМр░ир▒Б р░Йр░кр░пр▒Лр░Чр░┐р░Вр░Ър░┐ р░др░о р░╕р▒Кр░Вр░д р░Жр░╣р░╛р░░р░╛р░ир▒Нр░ир░┐ р░др░пр░╛р░░р▒Б р░Ър▒Зр░╕р▒Бр░Хр▒Бр░ир▒З р░╡р░┐р░зр░╛р░ир░В! ЁЯМ▒ р░ор▒Кр░Хр▒Нр░Хр░▓ р░Жр░Хр▒Бр░кр░Ър▒Нр░Ъ р░нр░╛р░Чр░╛р░▓р▒Б р░╕р▒Вр░░р▒Нр░пр░░р░╢р▒Нр░ор░┐р░ир░┐ р░╕р░Вр░Чр▒Нр░░р░╣р░┐р░Вр░Ър░┐ р░жр░╛р░ир░┐р░ир░┐ р░╢р░Хр▒Нр░др░┐р░Чр░╛ р░ор░╛р░░р▒Бр░╕р▒Нр░др░╛р░пр░┐. р░Зр░жр░┐ р░ор▒Кр░Хр▒Нр░Хр░▓р░Хр▒Б р░╡р░╛р░░р░┐ р░╕р▒Нр░╡р░Вр░д р░╕р▒Мр░░ р░кр▒Нр░пр░╛р░ир▒Жр░▓р▒Нр░╕р▒Н р░Йр░ир▒Нр░ир░Яр▒Нр░▓р▒Бр░Чр░╛ р░Йр░Вр░Яр▒Бр░Вр░жр░┐!",
      bn: "рж╕рж╛рж▓рзЛржХрж╕ржВрж╢рзНрж▓рзЗрж╖ржг рж╣рж▓ ржЙржжрзНржнрж┐ржж рж╕рзВрж░рзНржпрж╛рж▓рзЛржХ, ржЬрж▓ ржПржмржВ ржХрж╛рж░рзНржмржи ржбрж╛ржЗ ржЕржХрзНрж╕рж╛ржЗржб ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ рждрж╛ржжрзЗрж░ ржирж┐ржЬрж╕рзНржм ржЦрж╛ржжрзНржп рждрзИрж░рж┐ ржХрж░рж╛рж░ ржкрзНрж░ржХрзНрж░рж┐ржпрж╝рж╛! ЁЯМ▒ ржЙржжрзНржнрж┐ржжрзЗрж░ рж╕ржмрзБржЬ ржЕржВрж╢ржЧрзБрж▓рж┐ рж╕рзВрж░рзНржпрж╛рж▓рзЛржХ ржзрж░рзЗ ржПржмржВ ржПржЯрж┐ржХрзЗ рж╢ржХрзНрждрж┐рждрзЗ рж░рзВржкрж╛ржирзНрждрж░рж┐ржд ржХрж░рзЗред ржПржЯрж┐ ржПржоржи ржпрзЗржи ржЙржжрзНржнрж┐ржжрзЗрж░ ржирж┐ржЬрж╕рзНржм рж╕рзМрж░ ржкрзНржпрж╛ржирзЗрж▓ ржЖржЫрзЗ!",
    },
    math: {
      en: "Math is all about solving puzzles with numbers! ЁЯФв Start with the basics and practice regularly. Remember, every math expert was once a beginner just like you!",
      hi: "рдЧрдгрд┐рдд рд╕рдВрдЦреНрдпрд╛рдУрдВ рдХреЗ рд╕рд╛рде рдкрд╣реЗрд▓рд┐рдпрд╛рдБ рд╣рд▓ рдХрд░рдиреЗ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╣реИ! ЁЯФв рдореВрд▓ рдмрд╛рддреЛрдВ рд╕реЗ рд╢реБрд░реВ рдХрд░реЗрдВ рдФрд░ рдирд┐рдпрдорд┐рдд рд░реВрдк рд╕реЗ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВред рдпрд╛рдж рд░рдЦреЗрдВ, рд╣рд░ рдЧрдгрд┐рдд рд╡рд┐рд╢реЗрд╖рдЬреНрдЮ рдХрднреА рдЖрдкрдХреА рддрд░рд╣ рд╣реА рд╢реБрд░реБрдЖрддреА рдерд╛!",
      ta: "роХрогро┐родроорпН роОройрпНрокродрпБ роОрогрпНроХро│рпБроЯройрпН рокрпБродро┐ро░рпНроХро│рпИродрпН родрпАро░рпНрокрпНрокродрпБ! ЁЯФв роЕроЯро┐рокрпНрокроЯрпИроХро│рпБроЯройрпН родрпКроЯроЩрпНроХро┐ родрпКроЯро░рпНроирпНродрпБ рокропро┐ро▒рпНроЪро┐ роЪрпЖропрпНропрпБроЩрпНроХро│рпН. роиро┐ройрпИро╡ро┐ро▓рпН роХрпКро│рпНро│рпБроЩрпНроХро│рпН, роТро╡рпНро╡рпКро░рпБ роХрогро┐род роиро┐рокрпБрогро░рпБроорпН роТро░рпБ роХро╛ро▓родрпНродро┐ро▓рпН роЙроЩрпНроХро│рпИрокрпН рокрпЛройрпНро▒ роЖро░роорпНрокроиро┐ро▓рпИропро╛ро│ро░ро╛роХ роЗро░рпБроирпНродро╛ро░рпН!",
      te: "р░Чр░гр░┐р░др░В р░Ер░Вр░Яр▒З р░╕р░Вр░Цр▒Нр░пр░▓р░др▒Л р░кр░Ьр░┐р░▓р▒Нр░╕р▒Н р░кр░░р░┐р░╖р▒Нр░Хр░░р░┐р░Вр░Ър░бр░В! ЁЯФв р░кр▒Нр░░р░╛р░ер░ор░┐р░Хр░╛р░▓р░др▒Л р░кр▒Нр░░р░╛р░░р░Вр░нр░┐р░Вр░Ър░┐ р░Хр▒Нр░░р░ор░В р░др░кр▒Нр░кр░Хр▒Бр░Вр░бр░╛ р░Ер░нр▒Нр░пр░╕р░┐р░Вр░Ър░Вр░бр░┐. р░Чр▒Бр░░р▒Нр░др▒Бр░Вр░Ър▒Бр░Хр▒Лр░Вр░бр░┐, р░кр▒Нр░░р░др░┐ р░Чр░гр░┐р░д р░ир░┐р░кр▒Бр░гр▒Бр░бр▒Б р░Тр░Хр░кр▒Нр░кр▒Бр░бр▒Б р░ор▒Ар░▓р░╛р░Чр▒З р░кр▒Нр░░р░╛р░░р░Вр░нр░Хр▒Бр░бр▒З!",
      bn: "ржЧржгрж┐ржд рж╣рж▓ рж╕ржВржЦрзНржпрж╛ ржжрж┐ржпрж╝рзЗ ржзрж╛ржБржзрж╛ рж╕ржорж╛ржзрж╛ржи ржХрж░рж╛! ЁЯФв ржорзМрж▓рж┐ржХ ржмрж┐рж╖ржпрж╝ржЧрзБрж▓рж┐ ржжрж┐ржпрж╝рзЗ рж╢рзБрж░рзБ ржХрж░рзБржи ржПржмржВ ржирж┐ржпрж╝ржорж┐ржд ржЕржирзБрж╢рзАрж▓ржи ржХрж░рзБржиред ржоржирзЗ рж░рж╛ржЦржмрзЗржи, ржкрзНрж░рждрж┐ржЯрж┐ ржЧржгрж┐ржд ржмрж┐рж╢рзЗрж╖ржЬрзНржЮ ржПржХрж╕ржоржпрж╝ ржЖржкржирж╛рж░ ржорждрзЛржЗ рж╢рж┐ржХрзНрж╖рж╛ржиржмрж┐рж╕ ржЫрж┐рж▓рзЗржи!",
    },
    science: {
      en: "Science is super cool! It helps us understand how the world works. ЁЯФм Keep asking questions and stay curious - that's what scientists do!",
      hi: "рд╡рд┐рдЬреНрдЮрд╛рди рдмрд╣реБрдд рдЕрдЪреНрдЫрд╛ рд╣реИ! рдпрд╣ рд╣рдореЗрдВ рдпрд╣ рд╕рдордЭрдиреЗ рдореЗрдВ рдорджрдж рдХрд░рддрд╛ рд╣реИ рдХрд┐ рджреБрдирд┐рдпрд╛ рдХреИрд╕реЗ рдХрд╛рдо рдХрд░рддреА рд╣реИред ЁЯФм рдкреНрд░рд╢реНрди рдкреВрдЫрддреЗ рд░рд╣реЗрдВ рдФрд░ рдЬрд┐рдЬреНрдЮрд╛рд╕реБ рдмрдиреЗ рд░рд╣реЗрдВ - рд╡реИрдЬреНрдЮрд╛рдирд┐рдХ рдпрд╣реА рдХрд░рддреЗ рд╣реИрдВ!",
      ta: "роЕро▒ро┐ро╡ро┐ропро▓рпН рооро┐роХро╡рпБроорпН роЪрпБро╡ро╛ро░ро╕рпНропрооро╛ройродрпБ! роЙро▓роХроорпН роОро╡рпНро╡ро╛ро▒рпБ роЪрпЖропро▓рпНрокроЯрпБроХро┐ро▒родрпБ роОройрпНрокродрпИрокрпН рокрпБро░ро┐роирпНродрпБроХрпКро│рпНро│ роЗродрпБ роЙродро╡рпБроХро┐ро▒родрпБ. ЁЯФм роХрпЗро│рпНро╡ро┐роХро│рпН роХрпЗроЯрпНроЯрпБроХрпНроХрпКрогрпНроЯрпЗ роЗро░рпБроЩрпНроХро│рпН рооро▒рпНро▒рпБроорпН роЖро░рпНро╡рооро╛роХ роЗро░рпБроЩрпНроХро│рпН - ро╡ро┐роЮрпНроЮро╛ройро┐роХро│рпН роЕродрпИродрпНродро╛ройрпН роЪрпЖропрпНроХро┐ро▒ро╛ро░рпНроХро│рпН!",
      te: "р░╕р▒Ир░ир▒Нр░╕р▒Н р░Ър░╛р░▓р░╛ р░мр░╛р░Чр▒Бр░Вр░жр░┐! р░кр▒Нр░░р░кр░Вр░Ър░В р░Ор░▓р░╛ р░кр░ир░┐р░Ър▒Зр░╕р▒Нр░др▒Бр░Вр░жр▒Л р░Ер░░р▒Нр░ер░В р░Ър▒Зр░╕р▒Бр░Хр▒Лр░╡р░бр░╛р░ир░┐р░Хр░┐ р░Зр░жр░┐ р░ор░╛р░Хр▒Б р░╕р░╣р░╛р░пр░кр░бр▒Бр░др▒Бр░Вр░жр░┐. ЁЯФм р░кр▒Нр░░р░╢р▒Нр░ир░▓р▒Б р░Ер░бр░Чр░бр░В р░Хр▒Кр░ир░╕р░╛р░Чр░┐р░Вр░Ър░Вр░бр░┐ р░ор░░р░┐р░пр▒Б р░Жр░╕р░Хр▒Нр░др░┐р░Чр░╛ р░Йр░Вр░бр░Вр░бр░┐ - р░╢р░╛р░╕р▒Нр░др▒Нр░░р░╡р▒Зр░др▒Нр░др░▓р▒Б р░Ер░жр▒З р░Ър▒Зр░╕р▒Нр░др░╛р░░р▒Б!",
      bn: "ржмрж┐ржЬрзНржЮрж╛ржи ржЕрж╕рж╛ржзрж╛рж░ржг! ржПржЯрж┐ ржЖржорж╛ржжрзЗрж░ ржмрзБржЭрждрзЗ рж╕рж╛рж╣рж╛ржпрзНржп ржХрж░рзЗ ржпрзЗ ржкрзГржерж┐ржмрзА ржХрзАржнрж╛ржмрзЗ ржХрж╛ржЬ ржХрж░рзЗред ЁЯФм ржкрзНрж░рж╢рзНржи ржЬрж┐ржЬрзНржЮрж╛рж╕рж╛ ржХрж░рждрзЗ ржерж╛ржХрзБржи ржПржмржВ ржХрзМрждрзВрж╣рж▓рзА ржерж╛ржХрзБржи - ржмрж┐ржЬрзНржЮрж╛ржирзАрж░рж╛ ржПржЯрж╛ржЗ ржХрж░рзЗржи!",
    },
    default: {
      en: "Great question! ЁЯМЯ I'd love to help you learn more about that. Keep being curious and asking questions - that's how we learn best!",
      hi: "рдмрдврд╝рд┐рдпрд╛ рд╕рд╡рд╛рд▓! ЁЯМЯ рдореИрдВ рдЖрдкрдХреЛ рдЗрд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдФрд░ рдЬрд╛рдирдиреЗ рдореЗрдВ рдорджрдж рдХрд░рдирд╛ рдЪрд╛рд╣реВрдВрдЧрд╛ред рдЬрд┐рдЬреНрдЮрд╛рд╕реБ рдмрдиреЗ рд░рд╣реЗрдВ рдФрд░ рдкреНрд░рд╢реНрди рдкреВрдЫрддреЗ рд░рд╣реЗрдВ - рд╣рдо рдЗрд╕реА рддрд░рд╣ рд╕рдмрд╕реЗ рдЕрдЪреНрдЫрд╛ рд╕реАрдЦрддреЗ рд╣реИрдВ!",
      ta: "роЪро┐ро▒роирпНрод роХрпЗро│рпНро╡ро┐! ЁЯМЯ роЕродрпИрокрпН рокро▒рпНро▒ро┐ роорпЗро▓рпБроорпН роЕро▒ро┐роп роЙроЩрпНроХро│рпБроХрпНроХрпБ роЙродро╡ ро╡ро┐ро░рпБроорпНрокрпБроХро┐ро▒рпЗройрпН. роЖро░рпНро╡рооро╛роХ роЗро░рпБроЩрпНроХро│рпН рооро▒рпНро▒рпБроорпН роХрпЗро│рпНро╡ро┐роХро│рпН роХрпЗро│рпБроЩрпНроХро│рпН - роЕродрпБродро╛ройрпН роиро╛роорпН роЪро┐ро▒рокрпНрокро╛роХроХрпН роХро▒рпНро▒рпБроХрпНроХрпКро│рпНро│рпБроорпН ро╡ро┤ро┐!",
      te: "р░Чр▒Кр░кр▒Нр░к р░кр▒Нр░░р░╢р▒Нр░и! ЁЯМЯ р░жр░╛р░ир░┐ р░Чр▒Бр░░р░┐р░Вр░Ър░┐ р░ор░░р░┐р░Вр░д р░др▒Жр░▓р▒Бр░╕р▒Бр░Хр▒Лр░╡р░бр░╛р░ир░┐р░Хр░┐ р░ор▒Ар░Хр▒Б р░╕р░╣р░╛р░пр░В р░Ър▒Зр░пр░╛р░▓р░ир▒Бр░Хр▒Бр░Вр░Яр▒Бр░ир▒Нр░ир░╛р░ир▒Б. р░Жр░╕р░Хр▒Нр░др░┐р░Чр░╛ р░Йр░Вр░бр░Вр░бр░┐ р░ор░░р░┐р░пр▒Б р░кр▒Нр░░р░╢р▒Нр░ир░▓р▒Б р░Ер░бр░Чр░Вр░бр░┐ - р░ор░ир░В р░Йр░др▒Нр░др░ор░Вр░Чр░╛ р░ир▒Зр░░р▒Нр░Ър▒Бр░Хр▒Бр░ир▒З р░ор░╛р░░р▒Нр░Чр░В р░Ер░жр▒З!",
      bn: "ржжрзБрж░рзНржжрж╛ржирзНржд ржкрзНрж░рж╢рзНржи! ЁЯМЯ ржЖржорж┐ ржЖржкржирж╛ржХрзЗ ржПржЯрж┐ рж╕ржорзНржкрж░рзНржХрзЗ ржЖрж░ржУ ржЬрж╛ржирждрзЗ рж╕рж╛рж╣рж╛ржпрзНржп ржХрж░рждрзЗ ржЪрж╛ржЗред ржХрзМрждрзВрж╣рж▓рзА ржерж╛ржХрзБржи ржПржмржВ ржкрзНрж░рж╢рзНржи ржЬрж┐ржЬрзНржЮрж╛рж╕рж╛ ржХрж░рзБржи - ржПржнрж╛ржмрзЗржЗ ржЖржорж░рж╛ рж╕ржмржЪрзЗржпрж╝рзЗ ржнрж╛рж▓рзЛ рж╢рж┐ржЦрж┐!",
    },
  }

  // Check for keywords
  if (lowerMessage.includes("photosynthesis") || lowerMessage.includes("рдкреНрд░рдХрд╛рд╢") || lowerMessage.includes("роТро│ро┐роЪрпНроЪрпЗро░рпНроХрпНроХрпИ") || lowerMessage.includes("р░Хр░┐р░░р░гр░Ьр░ир▒Нр░п") || lowerMessage.includes("рж╕рж╛рж▓рзЛржХрж╕ржВрж╢рзНрж▓рзЗрж╖ржг")) {
    return responses.photosynthesis[language] || responses.photosynthesis.en
  } else if (lowerMessage.includes("math") || lowerMessage.includes("рдЧрдгрд┐рдд") || lowerMessage.includes("роХрогро┐родроорпН") || lowerMessage.includes("р░Чр░гр░┐р░др░В") || lowerMessage.includes("ржЧржгрж┐ржд")) {
    return responses.math[language] || responses.math.en
  } else if (lowerMessage.includes("science") || lowerMessage.includes("рд╡рд┐рдЬреНрдЮрд╛рди") || lowerMessage.includes("роЕро▒ро┐ро╡ро┐ропро▓рпН") || lowerMessage.includes("р░╕р▒Ир░ир▒Нр░╕р▒Н") || lowerMessage.includes("ржмрж┐ржЬрзНржЮрж╛ржи")) {
    return responses.science[language] || responses.science.en
  } else {
    return responses.default[language] || responses.default.en
  }
}

export async function POST(request: NextRequest) {
  try {
    const { studentId, message, language = "en" } = await request.json()

    if (!studentId || !message) {
      return NextResponse.json({ error: "Missing required fields" }, { status: 400 })
    }

    let text = ""

    // Language-specific system prompts
    const systemPrompts: Record<string, string> = {
      en: "You are a friendly AI Study Buddy helping students aged 10-15 with their academics. Always use simple, encouraging language. Explain complex topics in easy words. Be supportive and motivating. Keep responses concise (2-3 sentences). If asked non-academic questions, gently redirect to studies.",
      hi: "рдЖрдк 10-15 рд╡рд░реНрд╖ рдХреЗ рдЫрд╛рддреНрд░реЛрдВ рдХреА рд╢рд┐рдХреНрд╖рд╛ рдореЗрдВ рдорджрдж рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдПрдХ рдорд┐рддреНрд░рд╡рдд AI рдЕрдзреНрдпрдпрди рд╕рд╣рд╛рдпрдХ рд╣реИрдВред рд╣рдореЗрд╢рд╛ рд╕рд░рд▓, рдкреНрд░реЛрддреНрд╕рд╛рд╣рдХ рднрд╛рд╖рд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред рдЬрдЯрд┐рд▓ рд╡рд┐рд╖рдпреЛрдВ рдХреЛ рдЖрд╕рд╛рди рд╢рдмреНрджреЛрдВ рдореЗрдВ рд╕рдордЭрд╛рдПрдВред рд╕рд╣рд╛рдпрдХ рдФрд░ рдкреНрд░реЗрд░рдХ рдмрдиреЗрдВред рдЬрд╡рд╛рдм рд╕рдВрдХреНрд╖рд┐рдкреНрдд рд░рдЦреЗрдВ (2-3 рд╡рд╛рдХреНрдп)ред рдпрджрд┐ рдЧреИрд░-рд╢реИрдХреНрд╖рдгрд┐рдХ рдкреНрд░рд╢реНрди рдкреВрдЫреЗ рдЬрд╛рдПрдВ, рддреЛ рдзреАрд░реЗ рд╕реЗ рдЕрдзреНрдпрдпрди рдХреА рдУрд░ рдорд╛рд░реНрдЧрджрд░реНрд╢рди рдХрд░реЗрдВред",
      ta: "роирпАроЩрпНроХро│рпН 10-15 ро╡ропродрпБ рооро╛рогро╡ро░рпНроХро│рпБроХрпНроХрпБ роХро▓рпНро╡ро┐ропро┐ро▓рпН роЙродро╡рпБроорпН роироЯрпНрокрпБ AI рокроЯро┐рокрпНрокрпБ родрпБрогрпИ. роОрокрпНрокрпЛродрпБроорпН роОро│ро┐роп, роКроХрпНроХрооро│ро┐роХрпНроХрпБроорпН роорпКро┤ро┐ропрпИрокрпН рокропройрпНрокроЯрпБродрпНродрпБроЩрпНроХро│рпН. роЪро┐роХрпНроХро▓ро╛рой родро▓рпИрокрпНрокрпБроХро│рпИ роОро│ро┐роп ро╡ро╛ро░рпНродрпНродрпИроХро│ро┐ро▓рпН ро╡ро┐ро│роХрпНроХрпБроЩрпНроХро│рпН. роЖродро░ро╡ро╛роХро╡рпБроорпН роКроХрпНроХрооро│ро┐рокрпНрокро╡ро░ро╛роХро╡рпБроорпН роЗро░рпБроЩрпНроХро│рпН. рокродро┐ро▓рпНроХро│рпИ роЪрпБро░рпБроХрпНроХрооро╛роХ ро╡рпИродрпНродро┐ро░рпБроЩрпНроХро│рпН (2-3 ро╡ро╛роХрпНроХро┐ропроЩрпНроХро│рпН). роХро▓рпНро╡ро┐ роЪро╛ро░ро╛род роХрпЗро│рпНро╡ро┐роХро│рпН роХрпЗроЯрпНроЯро╛ро▓рпН, роорпЖродрпБро╡ро╛роХ рокроЯро┐рокрпНрокрпИ роирпЛроХрпНроХро┐ ро╡ро┤ро┐роироЯродрпНродрпБроЩрпНроХро│рпН.",
      te: "р░ор▒Ар░░р▒Б 10-15 р░╕р░Вр░╡р░др▒Нр░╕р░░р░╛р░▓ р░╡р░┐р░жр▒Нр░пр░╛р░░р▒Нр░ер▒Бр░▓р░Хр▒Б р░╡р░╛р░░р░┐ р░╡р░┐р░жр▒Нр░пр░▓р▒Л р░╕р░╣р░╛р░пр░В р░Ър▒Зр░╕р▒З р░╕р▒Нр░ир▒Зр░╣р░кр▒Вр░░р▒Нр░╡р░Х AI р░Ер░зр▒Нр░пр░пр░и р░╕р░╣р░╛р░пр░Хр▒Бр░бр▒Б. р░Ор░▓р▒Нр░▓р░кр▒Нр░кр▒Бр░бр▒В р░╕р░░р░│р░ор▒Ир░и, р░кр▒Нр░░р▒Лр░др▒Нр░╕р░╛р░╣р░Хр░░р░ор▒Ир░и р░нр░╛р░╖р░ир▒Б р░Йр░кр░пр▒Лр░Чр░┐р░Вр░Ър░Вр░бр░┐. р░╕р░Вр░Хр▒Нр░▓р░┐р░╖р▒Нр░Я р░Ер░Вр░╢р░╛р░▓р░ир▒Б р░╕р▒Бр░▓р░нр░ор▒Ир░и р░кр░жр░╛р░▓р░▓р▒Л р░╡р░┐р░╡р░░р░┐р░Вр░Ър░Вр░бр░┐. р░ор░жр▒Нр░жр░др▒Бр░Чр░╛ р░ор░░р░┐р░пр▒Б р░кр▒Нр░░р▒Зр░░р▒Зр░кр░Хр░Вр░Чр░╛ р░Йр░Вр░бр░Вр░бр░┐. р░╕р░ор░╛р░зр░╛р░ир░╛р░▓р░ир▒Б р░╕р░Вр░Хр▒Нр░╖р░┐р░кр▒Нр░др░Вр░Чр░╛ р░Йр░Вр░Ър░Вр░бр░┐ (2-3 р░╡р░╛р░Хр▒Нр░пр░╛р░▓р▒Б). р░╡р░┐р░жр▒Нр░пр▒Зр░др░░ р░кр▒Нр░░р░╢р▒Нр░ир░▓р▒Б р░Ер░бр░┐р░Чр░┐р░др▒З, р░ор▒Жр░▓р▒Нр░▓р░Чр░╛ р░Ър░жр▒Бр░╡р▒Бр░▓ р░╡р▒Ир░кр▒Б р░ор░│р▒Нр░▓р░┐р░Вр░Ър░Вр░бр░┐.",
      bn: "ржЖржкржирж┐ 10-15 ржмржЫрж░ ржмржпрж╝рж╕рзА рж╢рж┐ржХрзНрж╖рж╛рж░рзНржерзАржжрзЗрж░ рждрж╛ржжрзЗрж░ рж╢рж┐ржХрзНрж╖рж╛ржпрж╝ рж╕рж╛рж╣рж╛ржпрзНржп ржХрж░рж╛рж░ ржЬржирзНржп ржПржХржЯрж┐ ржмржирзНржзрзБрждрзНржмржкрзВрж░рзНржг AI ржЕржзрзНржпржпрж╝ржи рж╕рж╣рж╛ржпрж╝ржХред рж╕рж░рзНржмржжрж╛ рж╕рж╣ржЬ, ржЙрзОрж╕рж╛рж╣ржЬржиржХ ржнрж╛рж╖рж╛ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржиред ржЬржЯрж┐рж▓ ржмрж┐рж╖ржпрж╝ржЧрзБрж▓рж┐ рж╕рж╣ржЬ рж╢ржмрзНржжрзЗ ржмрзНржпрж╛ржЦрзНржпрж╛ ржХрж░рзБржиред рж╕рж╣рж╛ржпрж╝ржХ ржПржмржВ ржЕржирзБржкрзНрж░рзЗрж░ржгрж╛ржорзВрж▓ржХ рж╣ржиред ржЙрждрзНрждрж░ржЧрзБрж▓рж┐ рж╕ржВржХрзНрж╖рж┐ржкрзНржд рж░рж╛ржЦрзБржи (2-3 ржмрж╛ржХрзНржп)ред ржпржжрж┐ ржЕ-рж╢рж┐ржХрзНрж╖рж╛ржорзВрж▓ржХ ржкрзНрж░рж╢рзНржи ржЬрж┐ржЬрзНржЮрж╛рж╕рж╛ ржХрж░рж╛ рж╣ржпрж╝, рждрж╛рж╣рж▓рзЗ ржЖрж▓рждрзЛ ржХрж░рзЗ ржкржбрж╝рж╛рж╢рзЛржирж╛рж░ ржжрж┐ржХрзЗ ржкрзБржиржГржирж┐рж░рзНржжрзЗрж╢ ржХрж░рзБржиред",
    }

    // Try to use Google Generative AI if API key is valid
    try {
      const model = genAI.getGenerativeModel({ model: "gemini-pro" })

      const prompt = `${systemPrompts[language] || systemPrompts.en}

      Student question: ${message}`

      const result = await model.generateContent(prompt)
      const response = await result.response
      text = response.text()
    } catch (aiError) {
      console.error("AI API Error, using fallback response:", aiError)
      // Fallback responses for common questions in different languages
      text = getFallbackResponse(message, language)
    }

    // Store message history
    const userMessage = {
      id: `msg${Date.now()}`,
      studentId,
      role: "user" as const,
      content: message,
      timestamp: new Date().toISOString(),
    }

    const assistantMessage = {
      id: `msg${Date.now() + 1}`,
      studentId,
      role: "assistant" as const,
      content: text,
      timestamp: new Date().toISOString(),
    }

    database.chatMessages.push(userMessage)
    database.chatMessages.push(assistantMessage)

    return NextResponse.json(
      { success: true, data: { userMessage, assistantMessage, aiResponse: text } },
      { status: 200 },
    )
  } catch (error) {
    console.error("AI Chat Error:", error)
    return NextResponse.json({ error: "Failed to process message" }, { status: 500 })
  }
}

export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url)
    const studentId = searchParams.get("studentId")

    if (!studentId) {
      return NextResponse.json({ error: "Student ID required" }, { status: 400 })
    }

    const messages = database.chatMessages.filter((m) => m.studentId === studentId).slice(-20)

    return NextResponse.json({ success: true, data: messages }, { status: 200 })
  } catch (error) {
    return NextResponse.json({ error: "Failed to fetch messages" }, { status: 500 })
  }
}
